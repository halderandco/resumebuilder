<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>Resume Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&family=Source+Serif+Pro:wght@400;600&family=Space+Grotesk:wght@400;500;600&family=Work+Sans:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{background:#f6f9fc;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;height:100vh;display:flex;flex-direction:column;color:#142433;overflow:hidden;}
        .icon{display:inline-block;width:20px;height:20px;stroke-width:1.5;stroke:currentColor;fill:none;stroke-linecap:round;stroke-linejoin:round;vertical-align:middle;}
        .icon-sm{width:18px;height:18px;}
        .icon-lg{width:24px;height:24px;}
        .toolbar{background:#ffffffd9;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid rgba(0,0,0,0.04);padding:12px 32px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;box-shadow:0 4px 20px rgba(0,20,40,0.02);z-index:100;}
        .brand{font-size:20px;font-weight:700;letter-spacing:-0.01em;color:#0a2a33;display:flex;align-items:center;gap:8px;}
        .brand svg{width:28px;height:28px;stroke:#0a2a33;stroke-width:1.8;}
        .theme-control{display:flex;align-items:center;gap:20px;background:#f0f4fa;padding:6px 16px;border-radius:48px;border:1px solid #ffffff;}
        .theme-selector{background:transparent;border:none;padding:8px 28px 8px 16px;font-size:14px;font-weight:500;color:#1a3b4a;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231a3b4a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;cursor:pointer;}
        .btn-group{display:flex;gap:8px;}
        .btn{background:white;border:1px solid #d6e2eb;padding:10px 20px;border-radius:40px;font-size:14px;font-weight:600;color:#1a404f;display:inline-flex;align-items:center;gap:8px;transition:0.15s;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.02);}
        .btn-primary{background:#1a404f;border-color:#1a404f;color:white;}
        .btn:hover{background:#f4faff;border-color:#9cb8c7;transform:translateY(-1px);box-shadow:0 8px 14px rgba(26,64,79,0.08);}
        .btn-primary:hover{background:#255f72;border-color:#255f72;}
        .editor{display:flex;flex:1;overflow:hidden;background:#f2f6fb;}
        .form-panel{width:36%;background:white;border-right:1px solid rgba(0,0,0,0.04);padding:32px 28px;overflow-y:auto;box-shadow:8px 0 30px rgba(0,0,0,0.02);}
        .form-section{background:#ffffff;border-radius:28px;padding:24px;margin-bottom:24px;border:1px solid #edf4f8;box-shadow:0 10px 22px rgba(0,0,0,0.02);transition:0.2s;}
        .form-section:hover{border-color:#cde3ec;box-shadow:0 18px 30px rgba(26,64,79,0.04);}
        .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;font-size:16px;font-weight:700;color:#1a404f;letter-spacing:-0.01em;}
        .section-title svg{stroke:#1a404f;}
        .add-btn{background:#f0f9fc;border:1px solid #c5dbe5;border-radius:36px;padding:8px 18px;font-size:13px;font-weight:600;color:#1a404f;display:flex;align-items:center;gap:6px;cursor:pointer;transition:0.1s;}
        .add-btn:hover{background:#e2f0f6;}
        .form-group{position:relative;margin-bottom:20px;}
        label{display:block;font-size:11px;font-weight:700;color:#406e80;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.6px;}
        input,textarea{width:100%;padding:14px 18px;border:1.8px solid #e3ecf2;border-radius:20px;font-size:14px;background:#ffffff;transition:0.15s;}
        input:focus,textarea:focus{border-color:#347183;outline:none;box-shadow:0 0 0 4px rgba(52,113,131,0.08);}
        .ai-btn{position:absolute;right:12px;bottom:12px;background:#f0f9ff;border:none;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;color:#1a606f;cursor:pointer;border:1px solid transparent;transition:0.1s;}
        .ai-btn:hover{background:#dff0f7;border-color:#347183;transform:scale(1.05);}
        .item-card{background:#fafdff;border-radius:24px;padding:24px;margin-bottom:20px;border:1px solid #e5f0f5;position:relative;}
        .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;font-weight:600;color:#1f5163;}
        .item-actions{display:flex;gap:10px;}
        .item-btn{background:white;border:1px solid #d4e2ea;border-radius:32px;padding:6px 16px;font-size:12px;font-weight:600;color:#376c7c;display:flex;align-items:center;gap:6px;cursor:pointer;}
        .drag-handle{color:#89aebd;font-size:20px;cursor:grab;}
        .sortable-list{background:#f6fbfd;border-radius:24px;padding:12px;}
        .section-drag{background:white;border:1px solid #dfecf2;border-radius:20px;padding:16px 20px;margin-bottom:8px;display:flex;align-items:center;gap:12px;font-weight:600;color:#1b4b5a;cursor:grab;}
        .preview-panel{flex:1;background:#e7f0f5;padding:32px;overflow-y:auto;display:flex;flex-direction:column;align-items:center;}
        .preview-scroll{width:210mm;background:white;box-shadow:0 20px 40px -12px rgba(0,0,0,0.16);transform:scale(0.82);transform-origin:top center;border-radius:8px;transition:transform 0.2s;}
        .resume{background:white;}
        .ats-card{width:210mm;background:white;border-radius:28px;padding:28px;margin-top:28px;box-shadow:0 16px 32px rgba(0,0,0,0.04);border:1px solid #e9f0f5;}
        @media print{.toolbar,.form-panel,.ats-card,.preview-panel>:not(.preview-scroll),.no-print{display:none!important}.preview-panel{background:white;padding:0}.preview-scroll{transform:none;width:100%;box-shadow:none;border-radius:0;margin:0;}body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}
        .page-break-before{break-before:page;}
        li,.job,.education{break-inside:avoid;}
        .resume h2, .resume .section-title{break-after:avoid;}
        .resume section, .resume .section{break-inside:avoid;}
        .profile-img{width:68px;height:68px;border-radius:50%;object-fit:cover;border:3px solid white;box-shadow:0 6px 14px rgba(0,0,0,0.06);}
        .ai-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.2);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;}
        .ai-card{background:white;width:520px;border-radius:36px;padding:32px;box-shadow:0 30px 60px rgba(0,0,0,0.2);}
        .ai-suggestion{background:#f2fcfe;border-left:6px solid #1a606f;padding:18px;border-radius:16px;margin:16px 0;}
        .ai-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:28px;}
        .cert-item{background:#f7fcff;border-radius:18px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:12px;border:1px solid #d4e7ef;}
        .cert-input{flex:1;}
        .skill-chip{background:#eaf3f8;border-radius:30px;padding:8px 16px;display:inline-flex;align-items:center;gap:8px;margin:0 6px 8px 0;font-size:13px;border:1px solid #c3dce5;}
        .crop-container{position:relative;width:100%;height:400px;margin-bottom:16px;background:#f0f0f0;border-radius:12px;overflow:hidden;user-select:none;touch-action:none;}
        #cropCanvas{display:block;width:100%;height:100%;object-fit:contain;}
        #cropBox{position:absolute;border:2px solid white;box-shadow:0 0 0 9999px rgba(0,0,0,0.5);cursor:move;top:20%;left:20%;width:60%;height:60%;box-sizing:border-box;touch-action:none;}
        .crop-handle{position:absolute;width:12px;height:12px;background:white;border:1px solid #1a404f;border-radius:2px;}
    </style>
    <style>
        body{background:#faf7f2;}
        .toolbar{background:#ffffff;border-bottom:1px solid #e2dcd2;box-shadow:0 4px 20px rgba(0,0,0,0.02);}
        .brand{color:#2e3b4e;}
        .brand svg{stroke:#2e3b4e;}
        .theme-control{background:#f5f3f0;border:1px solid #e4dfd8;}
        .theme-selector{color:#3e4c5c;}
        .btn{background:#ffffff;border:1px solid #d6d2cb;color:#3e4c5c;}
        .btn:hover{background:#faf8f5;border-color:#b0a99f;}
        .btn-primary{background:#5f6a7a;border-color:#5f6a7a;color:white;}
        .btn-primary:hover{background:#4d5766;border-color:#4d5766;}
        .editor{background:#f5f2ed;}
        .form-panel{background:#ffffff;border-right:1px solid #eae5de;box-shadow:8px 0 30px rgba(0,0,0,0.02);}
        .form-section{border:1px solid #ece7e2;background:#ffffff;}
        .form-section:hover{border-color:#cbc3ba;}
        .section-title{color:#5f6a7a;}
        .add-btn{background:#f5f3f0;border-color:#d6d2cb;color:#4d5766;}
        .add-btn:hover{background:#eae7e2;}
        label{color:#6a7a86;}
        input,textarea{border-color:#e2ddd6;}
        input:focus,textarea:focus{border-color:#8d9aa6;box-shadow:0 0 0 4px rgba(93,106,120,0.08);}
        .ai-btn{background:#f5f3f0;color:#5f6a7a;}
        .ai-btn:hover{background:#eae7e2;}
        .item-card{background:#ffffff;border-color:#eae5de;}
        .item-header{color:#4d5766;}
        .item-btn{background:#ffffff;border-color:#d6d2cb;color:#4d5766;}
        .drag-handle{color:#9aa3ad;}
        .sortable-list{background:#faf8f5;}
        .section-drag{background:#ffffff;border-color:#e2ddd6;color:#4d5766;}
        .preview-panel{background:#eae5de;}
        .preview-scroll{box-shadow:0 20px 40px -12px rgba(0,0,0,0.08);}
        .ats-card{border-color:#e2ddd6;}
        .ai-card{background:#ffffff;box-shadow:0 30px 60px rgba(0,0,0,0.08);}
        .ai-suggestion{background:#f9f7f3;border-left-color:#8d9aa6;}
        .cert-item{background:#ffffff;border-color:#e2ddd6;}
        .skill-chip{background:#f5f3f0;border-color:#d6d2cb;color:#4d5766;}
    </style>
    <style>
        @media screen and (max-width: 1024px) {
            .toolbar { padding: 12px 20px; }
            .brand { font-size: 18px; }
            .btn-group { gap: 6px; }
            .btn { padding: 8px 16px; font-size: 13px; }
            .preview-scroll { transform: scale(0.7); }
        }
        @media screen and (max-width: 768px) {
            body { overflow: auto; }
            .editor { flex-direction: column; overflow: visible; }
            .form-panel { width: 100%; border-right: none; border-bottom: 1px solid #eae5de; padding: 24px 20px; }
            .preview-panel { padding: 24px 16px; }
            .preview-scroll { width: 100%; transform: scale(0.65); }
            .toolbar { flex-direction: column; align-items: stretch; gap: 12px; }
            .toolbar-left, .toolbar-right { justify-content: center; }
            .theme-control { align-self: center; }
            .btn-group { flex-wrap: wrap; justify-content: center; }
        }
        @media screen and (max-width: 480px) {
            .form-panel { padding: 20px 16px; }
            .form-section { padding: 18px; }
            .preview-panel { padding: 16px 8px; }
            .preview-scroll { transform: scale(0.5); }
            .btn { padding: 8px 12px; font-size: 12px; }
            .brand { font-size: 16px; }
            .brand svg { width: 24px; height: 24px; }
            .theme-control { gap: 8px; padding: 4px 12px; }
            .theme-selector { padding: 6px 24px 6px 12px; font-size: 12px; }
        }
    </style>
    <!-- ===== FIXED PRINT STYLES – professional margins, zero page margins, perfect alignment ===== -->
    <style>
        @media print {
            @page {
                margin: 0;
                size: A4;
            }
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                height: auto !important;
                overflow: visible !important;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .toolbar, .form-panel, .ats-card, .preview-panel > :not(.preview-scroll), .no-print {
                display: none !important;
            }
            .preview-panel {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
                width: 100% !important;
                height: auto !important;
            }
            .preview-scroll {
                transform: none !important;
                width: 210mm !important;
                margin: 0 auto !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                background: white !important;
            }
            .resume {
                margin: 0 !important;
                width: 210mm !important;
                min-height: 297mm !important;
                box-sizing: border-box !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }
        }
    </style>
    <!-- ===== END FIXED PRINT STYLES ===== -->
</head>
<body>
    <svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
        <symbol id="icon-brand" viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M8 8h8v8H8z"/><path d="M12 12v4"/></symbol>
        <symbol id="icon-save" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></symbol>
        <symbol id="icon-reset" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></symbol>
        <symbol id="icon-print" viewBox="0 0 24 24"><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 9V3h12v6"/><rect x="6" y="15" width="12" height="6" rx="2"/></symbol>
        <symbol id="icon-ats" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
        <symbol id="icon-duplicate" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></symbol>
        <symbol id="icon-ai" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><circle cx="12" cy="8" r="0.5" fill="currentColor"/></symbol>
        <symbol id="icon-drag" viewBox="0 0 24 24"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="8" r="1"/><circle cx="15" cy="8" r="1"/><circle cx="9" cy="16" r="1"/><circle cx="15" cy="16" r="1"/></symbol>
        <symbol id="icon-predict" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></symbol>
        <symbol id="icon-download" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
        <symbol id="icon-crop" viewBox="0 0 24 24"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"/><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"/></symbol>
    </svg>

    <div class="toolbar no-print">
        <div class="brand"><svg class="icon-lg"><use href="#icon-brand"></use></svg>RESUME BUILDER</div>
        <div class="theme-control"><span style="color:#1a404f;font-weight:500;">Theme</span><select id="themeSelector" class="theme-selector"></select></div>
        <div class="btn-group">
            <button id="saveBtn" class="btn"><svg class="icon"><use href="#icon-save"></use></svg> Save</button>
            <button id="resetBtn" class="btn"><svg class="icon"><use href="#icon-reset"></use></svg> Reset</button>
            <button id="printBtn" class="btn"><svg class="icon"><use href="#icon-print"></use></svg> Print</button>
            <button id="atsBtn" class="btn btn-primary"><svg class="icon"><use href="#icon-ats"></use></svg> ATS</button>
            <button id="downloadPdfBtn" class="btn"><svg class="icon"><use href="#icon-download"></use></svg> Download PDF</button>
        </div>
    </div>

    <div class="editor">
        <div id="formPanel" class="form-panel no-print"></div>
        <div class="preview-panel">
            <div class="preview-scroll" id="previewFrame"><div id="resumePreview" class="resume"></div></div>
            <div id="atsContainer" class="ats-card no-print" style="display:none;">
                <h3 style="margin-bottom:16px;display:flex;gap:8px;"><svg class="icon" style="stroke:#1a404f;"><use href="#icon-ats"></use></svg>ATS Alignment</h3>
                <div id="atsScore"></div>
            </div>
            <div class="ats-card no-print" style="margin-top:20px;background:#f7fcff;">
                <div style="display:flex;gap:16px;align-items:center;">
                    <textarea id="jobDescription" rows="3" style="flex:1;border:1.8px solid #d2e5ed;border-radius:24px;padding:16px;font-size:14px;" placeholder="Paste job description...">Senior UX Designer with Figma, prototyping, user research, design systems, SaaS.</textarea>
                    <button id="analyzeBtn" class="btn btn-primary" style="white-space:nowrap;">Analyze</button>
                </div>
            </div>
        </div>
    </div>

    <div id="aiSkillModal" class="ai-modal no-print" style="display:none;">
        <div class="ai-card">
            <h3 style="display:flex;gap:8px;margin-bottom:12px;"><svg class="icon" style="stroke:#1a606f;"><use href="#icon-predict"></use></svg>AI Skill Predictor</h3>
            <p style="margin-bottom:16px;color:#347183;">Suggested skills based on your profile:</p>
            <div id="skillSuggestionsList" style="max-height:300px;overflow-y:auto;"></div>
            <div class="ai-actions">
                <button id="aiSkillCancel" class="item-btn">Cancel</button>
                <button id="aiSkillApply" class="btn btn-primary">Apply Selected</button>
            </div>
        </div>
    </div>

    <div id="aiModal" class="ai-modal no-print" style="display:none;">
        <div class="ai-card">
            <h3 style="display:flex;gap:8px;margin-bottom:12px;"><svg class="icon" style="stroke:#1a606f;"><use href="#icon-ai"></use></svg>AI Writing Assistant</h3>
            <div id="aiOriginal" style="background:#f1f7fa;padding:16px;border-radius:16px;margin-bottom:16px;font-size:14px;"></div>
            <div id="aiSuggestions" style="margin-bottom:24px;"></div>
            <div class="ai-actions">
                <button id="aiCancel" class="item-btn">Cancel</button>
                <button id="aiApply" class="btn btn-primary">Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- ===== ENHANCED CROPPER – touch support, zoom, fallback dimensions, smooth ===== -->
    <div id="cropModal" class="ai-modal no-print" style="display:none;">
        <div class="ai-card" style="width:640px;">
            <h3 style="display:flex;gap:8px;margin-bottom:12px;"><svg class="icon" style="stroke:#1a606f;"><use href="#icon-crop"></use></svg>Crop Profile Picture</h3>
            <div class="crop-container" id="cropContainer">
                <canvas id="cropCanvas"></canvas>
                <div id="cropBox">
                    <div class="crop-handle" style="top:-6px; left:-6px; cursor:nw-resize;"></div>
                    <div class="crop-handle" style="top:-6px; right:-6px; cursor:ne-resize;"></div>
                    <div class="crop-handle" style="bottom:-6px; left:-6px; cursor:sw-resize;"></div>
                    <div class="crop-handle" style="bottom:-6px; right:-6px; cursor:se-resize;"></div>
                </div>
            </div>
            <div style="display:flex; gap:16px; margin-bottom:16px; justify-content:center;">
                <button id="cropZoomInBtn" class="item-btn">➕ Zoom In</button>
                <button id="cropZoomOutBtn" class="item-btn">➖ Zoom Out</button>
                <button id="cropResetBtn" class="item-btn">↺ Reset</button>
            </div>
            <div class="ai-actions">
                <button id="cropCancelBtn" class="item-btn">Cancel</button>
                <button id="cropSaveBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
    <!-- ===== END ENHANCED CROPPER ===== -->

    <script>
        (function(){
            "use strict";

            const STORAGE_KEY = 'arc_resume_enterprise_v3';
            const DEFAULT_STATE = {
                profileImage: null,
                name: 'Taylor Reed',
                title: 'Senior UX Designer',
                email: 'taylor.reed@email.com',
                phone: '+1 (415) 555-0198',
                location: 'San Francisco, CA',
                summary: 'Senior UX designer with 6 years of experience in enterprise SaaS. Passionate about inclusive design and data‑driven decision making.',
                experience: [
                    { id: 'exp1', role: 'Lead UX Designer', company: 'DesignFlow', date: '2021 – present', bullets: [
                        'Spearheaded redesign of analytics dashboard, increasing user engagement by 34%.',
                        'Established component library used by 8 product teams.'
                    ]},
                    { id: 'exp2', role: 'UX/UI Designer', company: 'AppCraft', date: '2018 – 2021', bullets: [
                        'Designed end‑to‑end mobile app for inventory management.',
                        'Conducted 25+ usability sessions, iterating on low‑fidelity prototypes.'
                    ]}
                ],
                education: [
                    { id: 'edu1', degree: 'M.S. Human‑Computer Interaction', school: 'Stanford University', year: '2018' },
                    { id: 'edu2', degree: 'B.A. Psychology', school: 'UC Berkeley', year: '2016' }
                ],
                skills: ['UX Research', 'Wireframing', 'Prototyping', 'Figma', 'Adobe XD', 'User Testing', 'HTML/CSS'],
                certifications: ['Google UX Design Professional', 'NN/g UX Certification'],
                sectionOrder: ['profile', 'experience', 'education', 'skills', 'certifications'],
                visibility: { profile: true, experience: true, education: true, skills: true, certifications: true },
                activeTheme: 'theme2c1'
            };

            let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
            try { const saved = localStorage.getItem(STORAGE_KEY); if(saved) state = JSON.parse(saved); } catch(e){}

            function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

            // ===== FIXED PAGINATION – dynamic, theme‑aware, professional =====
            function applyPagination() {
                const resumeEl = document.querySelector('.resume');
                if (!resumeEl) return;
                document.querySelectorAll('.page-break-before').forEach(el => el.classList.remove('page-break-before'));
                const children = Array.from(resumeEl.children);
                
                const style = window.getComputedStyle(resumeEl);
                const pt = parseFloat(style.paddingTop) || 0;
                const pb = parseFloat(style.paddingBottom) || 0;
                const pxPerMm = 3.779527559;
                const paddingTopMm = pt / pxPerMm;
                const paddingBottomMm = pb / pxPerMm;
                const availableHeight = 297 - paddingTopMm - paddingBottomMm;
                let remainingSpace = availableHeight;
                
                for (let i = 0; i < children.length; i++) {
                    const el = children[i];
                    const height = el.getBoundingClientRect().height / pxPerMm;
                    if (height > remainingSpace && i > 0) {
                        el.classList.add('page-break-before');
                        remainingSpace = availableHeight - height;
                    } else {
                        remainingSpace -= height;
                    }
                }
            }
            // ===== END FIXED PAGINATION =====

            // ========== ENHANCED CROPPER – cross‑device, touch, zoom, robust ==========
            let cropState = {
                image: null,
                canvas: null,
                ctx: null,
                imgWidth: 0,
                imgHeight: 0,
                containerWidth: 0,
                containerHeight: 400,
                fitScale: 1,           // initial fit-to-container scale
                zoom: 1,              // additional zoom factor
                displayWidth: 0,
                displayHeight: 0,
                offsetX: 0,
                offsetY: 0,
                cropBox: { x: 0, y: 0, w: 0, h: 0 },
                isDragging: false,
                dragMode: null,
                startX: 0,
                startY: 0,
                startBox: null,
                animationFrame: null
            };

            function updateCropBoxDiv() {
                const div = document.getElementById('cropBox');
                div.style.left = cropState.cropBox.x + 'px';
                div.style.top = cropState.cropBox.y + 'px';
                div.style.width = cropState.cropBox.w + 'px';
                div.style.height = cropState.cropBox.h + 'px';
            }

            function drawCropCanvas() {
                const { ctx, canvas, image, offsetX, offsetY, displayWidth, displayHeight, cropBox } = cropState;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, offsetX, offsetY, displayWidth, displayHeight);
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.beginPath();
                ctx.rect(cropBox.x, cropBox.y, cropBox.w, cropBox.h);
                ctx.clip();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, offsetX, offsetY, displayWidth, displayHeight);
                ctx.restore();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.strokeRect(cropBox.x, cropBox.y, cropBox.w, cropBox.h);
            }

            function clampCropBox() {
                const { cropBox, offsetX, offsetY, displayWidth, displayHeight } = cropState;
                cropBox.x = Math.max(offsetX, Math.min(offsetX + displayWidth - cropBox.w, cropBox.x));
                cropBox.y = Math.max(offsetY, Math.min(offsetY + displayHeight - cropBox.h, cropBox.y));
                cropBox.w = Math.min(displayWidth, Math.max(50, cropBox.w));
                cropBox.h = cropBox.w; // keep square
                if (cropBox.x + cropBox.w > offsetX + displayWidth) cropBox.x = offsetX + displayWidth - cropBox.w;
                if (cropBox.y + cropBox.h > offsetY + displayHeight) cropBox.y = offsetY + displayHeight - cropBox.h;
            }

            function zoomAtCenter(delta) {
                const oldZoom = cropState.zoom;
                let newZoom = oldZoom * delta;
                newZoom = Math.max(0.3, Math.min(3, newZoom));
                if (newZoom === oldZoom) return;
                
                const { cropBox, offsetX, offsetY, displayWidth, displayHeight, fitScale, imgWidth, imgHeight, containerWidth, containerHeight } = cropState;
                const oldDisplayWidth = displayWidth;
                const oldDisplayHeight = displayHeight;
                
                // calculate new display dimensions
                const newDisplayWidth = imgWidth * fitScale * newZoom;
                const newDisplayHeight = imgHeight * fitScale * newZoom;
                
                // get centre of crop box in image coordinates (relative to image top-left)
                const imgCropCenterX = (cropBox.x + cropBox.w/2 - offsetX) / oldDisplayWidth * imgWidth;
                const imgCropCenterY = (cropBox.y + cropBox.h/2 - offsetY) / oldDisplayHeight * imgHeight;
                
                // new offsets to keep that centre at same screen position
                const newOffsetX = containerWidth/2 - (imgCropCenterX / imgWidth * newDisplayWidth);
                const newOffsetY = containerHeight/2 - (imgCropCenterY / imgHeight * newDisplayHeight);
                
                cropState.zoom = newZoom;
                cropState.displayWidth = newDisplayWidth;
                cropState.displayHeight = newDisplayHeight;
                cropState.offsetX = newOffsetX;
                cropState.offsetY = newOffsetY;
                
                // clamp offsets
                cropState.offsetX = Math.min(containerWidth, Math.max(containerWidth - newDisplayWidth, cropState.offsetX));
                cropState.offsetY = Math.min(containerHeight, Math.max(containerHeight - newDisplayHeight, cropState.offsetY));
                
                // adjust crop box size proportionally (keep same relative size)
                const relSize = cropBox.w / oldDisplayWidth;
                cropState.cropBox.w = newDisplayWidth * relSize;
                cropState.cropBox.h = cropState.cropBox.w;
                
                // ensure crop box stays within image bounds
                clampCropBox();
                
                drawCropCanvas();
                updateCropBoxDiv();
            }

            function initCropper(imageDataUrl) {
                const modal = document.getElementById('cropModal');
                const canvas = document.getElementById('cropCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Show modal FIRST so container has dimensions
                    modal.style.display = 'flex';
                    
                    // Fallback dimensions if container.clientWidth is 0 (rare, but happens on some mobile)
                    const container = document.getElementById('cropContainer');
                    let containerWidth = container.clientWidth;
                    if (containerWidth === 0) {
                        // Use modal card width minus padding
                        const card = modal.querySelector('.ai-card');
                        containerWidth = card.clientWidth - 64; // 32px padding each side
                        if (containerWidth < 100) containerWidth = 576; // ultimate fallback
                    }
                    const containerHeight = 400;
                    
                    canvas.width = containerWidth;
                    canvas.height = containerHeight;
                    
                    const fitScale = Math.min(containerWidth / img.width, containerHeight / img.height);
                    const displayWidth = img.width * fitScale;
                    const displayHeight = img.height * fitScale;
                    const offsetX = (containerWidth - displayWidth) / 2;
                    const offsetY = (containerHeight - displayHeight) / 2;
                    const size = Math.min(displayWidth, displayHeight) * 0.7;
                    const cropBox = {
                        x: offsetX + (displayWidth - size) / 2,
                        y: offsetY + (displayHeight - size) / 2,
                        w: size,
                        h: size
                    };
                    
                    cropState = {
                        image: img,
                        canvas,
                        ctx,
                        imgWidth: img.width,
                        imgHeight: img.height,
                        containerWidth,
                        containerHeight,
                        fitScale,
                        zoom: 1,
                        displayWidth,
                        displayHeight,
                        offsetX,
                        offsetY,
                        cropBox,
                        isDragging: false,
                        dragMode: null,
                        startX: 0,
                        startY: 0,
                        startBox: null,
                        animationFrame: null
                    };
                    
                    drawCropCanvas();
                    updateCropBoxDiv();
                };
                img.src = imageDataUrl;
            }

            function setupCropEvents() {
                const container = document.getElementById('cropContainer');
                const cropBoxEl = document.getElementById('cropBox');
                
                // unified pointer handler
                function getPointerCoords(e) {
                    e.preventDefault();
                    const rect = container.getBoundingClientRect();
                    let clientX, clientY;
                    if (e.touches) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
                    return { x: clientX - rect.left, y: clientY - rect.top };
                }
                
                function startDrag(e) {
                    e.preventDefault();
                    const { x, y } = getPointerCoords(e);
                    const box = cropState.cropBox;
                    const handleSize = 20; // larger hit area for touch
                    
                    // detect handle or move
                    if (Math.hypot(x - box.x, y - box.y) < handleSize) cropState.dragMode = 'nw';
                    else if (Math.hypot(x - (box.x + box.w), y - box.y) < handleSize) cropState.dragMode = 'ne';
                    else if (Math.hypot(x - box.x, y - (box.y + box.h)) < handleSize) cropState.dragMode = 'sw';
                    else if (Math.hypot(x - (box.x + box.w), y - (box.y + box.h)) < handleSize) cropState.dragMode = 'se';
                    else if (x >= box.x && x <= box.x + box.w && y >= box.y && y <= box.y + box.h) cropState.dragMode = 'move';
                    else cropState.dragMode = null;
                    
                    if (cropState.dragMode) {
                        cropState.isDragging = true;
                        cropState.startX = x;
                        cropState.startY = y;
                        cropState.startBox = { ...box };
                    }
                }
                
                function onDrag(e) {
                    if (!cropState.isDragging) return;
                    e.preventDefault();
                    
                    if (cropState.animationFrame) cancelAnimationFrame(cropState.animationFrame);
                    cropState.animationFrame = requestAnimationFrame(() => {
                        const { x, y } = getPointerCoords(e);
                        const dx = x - cropState.startX;
                        const dy = y - cropState.startY;
                        const newBox = { ...cropState.startBox };
                        const { offsetX, offsetY, displayWidth, displayHeight } = cropState;
                        
                        if (cropState.dragMode === 'move') {
                            newBox.x = cropState.startBox.x + dx;
                            newBox.y = cropState.startBox.y + dy;
                        } else if (cropState.dragMode === 'se') {
                            newBox.w = Math.max(50, cropState.startBox.w + dx);
                            newBox.h = newBox.w;
                        } else if (cropState.dragMode === 'nw') {
                            newBox.w = Math.max(50, cropState.startBox.w - dx);
                            newBox.h = newBox.w;
                            newBox.x = cropState.startBox.x + (cropState.startBox.w - newBox.w);
                            newBox.y = cropState.startBox.y + (cropState.startBox.h - newBox.h);
                        } else if (cropState.dragMode === 'ne') {
                            newBox.w = Math.max(50, cropState.startBox.w + dx);
                            newBox.h = newBox.w;
                            newBox.y = cropState.startBox.y + (cropState.startBox.h - newBox.h);
                        } else if (cropState.dragMode === 'sw') {
                            newBox.w = Math.max(50, cropState.startBox.w - dx);
                            newBox.h = newBox.w;
                            newBox.x = cropState.startBox.x + (cropState.startBox.w - newBox.w);
                        }
                        
                        // clamp within image bounds
                        newBox.x = Math.max(offsetX, Math.min(offsetX + displayWidth - newBox.w, newBox.x));
                        newBox.y = Math.max(offsetY, Math.min(offsetY + displayHeight - newBox.h, newBox.y));
                        newBox.w = Math.min(displayWidth, newBox.w);
                        newBox.h = newBox.w;
                        
                        cropState.cropBox = newBox;
                        drawCropCanvas();
                        updateCropBoxDiv();
                        cropState.animationFrame = null;
                    });
                }
                
                function endDrag(e) {
                    if (cropState.isDragging) {
                        e.preventDefault();
                        cropState.isDragging = false;
                        cropState.dragMode = null;
                        if (cropState.animationFrame) {
                            cancelAnimationFrame(cropState.animationFrame);
                            cropState.animationFrame = null;
                        }
                    }
                }
                
                // mouse events
                container.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', onDrag);
                window.addEventListener('mouseup', endDrag);
                
                // touch events
                container.addEventListener('touchstart', startDrag, { passive: false });
                window.addEventListener('touchmove', onDrag, { passive: false });
                window.addEventListener('touchend', endDrag);
                window.addEventListener('touchcancel', endDrag);
                
                // zoom implementation
                document.getElementById('cropZoomInBtn').onclick = () => zoomAtCenter(1.2);
                document.getElementById('cropZoomOutBtn').onclick = () => zoomAtCenter(0.8);
                document.getElementById('cropResetBtn').onclick = () => {
                    if (!cropState.image) return;
                    const { containerWidth, containerHeight, fitScale, imgWidth, imgHeight } = cropState;
                    cropState.zoom = 1;
                    cropState.displayWidth = imgWidth * fitScale;
                    cropState.displayHeight = imgHeight * fitScale;
                    cropState.offsetX = (containerWidth - cropState.displayWidth) / 2;
                    cropState.offsetY = (containerHeight - cropState.displayHeight) / 2;
                    const size = Math.min(cropState.displayWidth, cropState.displayHeight) * 0.7;
                    cropState.cropBox = {
                        x: cropState.offsetX + (cropState.displayWidth - size) / 2,
                        y: cropState.offsetY + (cropState.displayHeight - size) / 2,
                        w: size,
                        h: size
                    };
                    drawCropCanvas();
                    updateCropBoxDiv();
                };
            }

            function cropAndSave() {
                const { image, cropBox, offsetX, offsetY, displayWidth, displayHeight, imgWidth, imgHeight } = cropState;
                
                const ratioX = imgWidth / displayWidth;
                const ratioY = imgHeight / displayHeight;
                const cropX = (cropBox.x - offsetX) * ratioX;
                const cropY = (cropBox.y - offsetY) * ratioY;
                const cropW = cropBox.w * ratioX;
                const cropH = cropBox.h * ratioY;
                
                const outputCanvas = document.createElement('canvas');
                outputCanvas.width = 400;
                outputCanvas.height = 400;
                const outCtx = outputCanvas.getContext('2d');
                outCtx.drawImage(image, cropX, cropY, cropW, cropH, 0, 0, 400, 400);
                
                const croppedDataUrl = outputCanvas.toDataURL('image/jpeg', 0.95);
                state.profileImage = croppedDataUrl;
                
                renderForm();
                renderPreview();
                persist();
                document.getElementById('cropModal').style.display = 'none';
            }
            // ========== END ENHANCED CROPPER ==========

            const twoColThemes = [
                { id: 'theme2c1', name: '2C · Ocean Splash', accent: '#0b5e7c', leftBg: '#e3f0f5', font: 'Inter', bullet: '▹', cols: '1fr 2.2fr', shadow: '0 8px 20px rgba(11,94,124,0.08)', radius: '16px' },
                { id: 'theme2c2', name: '2C · Golden Hour', accent: '#b86f2c', leftBg: '#fff1e0', font: 'DM Sans', bullet: '◆', cols: '1.2fr 1.8fr', shadow: '0 8px 24px rgba(184,111,44,0.06)', radius: '20px' },
                { id: 'theme2c3', name: '2C · Emerald', accent: '#2e6d5e', leftBg: '#e9f3ef', font: 'Lexend', bullet: '✦', cols: '1fr 2.1fr', shadow: '0 8px 24px rgba(46,109,94,0.06)', radius: '12px' },
                { id: 'theme2c4', name: '2C · Blush', accent: '#b35e6b', leftBg: '#fdedf0', font: 'Work Sans', bullet: '•', cols: '1fr 2.4fr', shadow: '0 8px 24px rgba(179,94,107,0.06)', radius: '24px' },
                { id: 'theme2c5', name: '2C · Graphite', accent: '#4d6a7e', leftBg: '#eef2f6', font: 'Inter', bullet: '▪', cols: '1.2fr 2.2fr', shadow: '0 8px 24px rgba(77,106,126,0.06)', radius: '8px' },
                { id: 'theme2c6', name: '2C · Teal', accent: '#1d7a7c', leftBg: '#dcf0f0', font: 'Inter', bullet: '▸', cols: '1.3fr 2fr', shadow: '0 8px 24px rgba(29,122,124,0.06)', radius: '18px' },
                { id: 'theme2c7', name: '2C · Mauve', accent: '#90648b', leftBg: '#f9edf7', font: 'Georgia', bullet: '—', cols: '1.1fr 2.3fr', shadow: '0 8px 24px rgba(144,100,139,0.06)', radius: '16px' },
                { id: 'theme2c8', name: '2C · Olive', accent: '#6f7e4a', leftBg: '#f4f7e8', font: 'Source Serif Pro', bullet: '•', cols: '1fr 2.2fr', shadow: '0 8px 24px rgba(111,126,74,0.06)', radius: '12px' },
                { id: 'theme2c9', name: '2C · Cobalt', accent: '#2c5f8a', leftBg: '#e3ecf5', font: 'Inter', bullet: '▹', cols: '1.2fr 1.9fr', shadow: '0 8px 24px rgba(44,95,138,0.06)', radius: '14px' },
                { id: 'theme2c10', name: '2C · Orchid', accent: '#9565b3', leftBg: '#f5ebfa', font: 'Inter', bullet: '◇', cols: '1.3fr 2fr', shadow: '0 8px 24px rgba(149,101,179,0.06)', radius: '22px' }
            ];

            const singleThemes = [
                { id: 'theme1c1', name: '1C · Executive Noir', font: 'Playfair Display', accent: '#2d3e50', bg: '#ffffff', style: 'executive' },
                { id: 'theme1c2', name: '1C · ATS Pure', font: 'Inter', accent: '#1f5e6b', bg: '#ffffff', style: 'ats' },
                { id: 'theme1c3', name: '1C · Soft Minimal', font: 'Inter', accent: '#567d7e', bg: '#fefefe', style: 'minimal' },
                { id: 'theme1c4', name: '1C · Creative Pop', font: 'Space Grotesk', accent: '#e1693c', bg: '#fff9f5', style: 'creative' },
                { id: 'theme1c5', name: '1C · Midnight', font: 'Georgia', accent: '#dbb957', bg: '#1a292f', style: 'dark' },
                { id: 'theme1c6', name: '1C · Mono Tech', font: 'Courier New', accent: '#26738b', bg: '#f5f9fc', style: 'mono' },
                { id: 'theme1c7', name: '1C · Serif Classic', font: 'Source Serif Pro', accent: '#7f5539', bg: '#fdf8f2', style: 'classic' },
                { id: 'theme1c8', name: '1C · Linen', font: 'Inter', accent: '#a55d3d', bg: '#fff7ee', style: 'linen' },
                { id: 'theme1c9', name: '1C · Arctic', font: 'Inter', accent: '#407c87', bg: '#f2fbfd', style: 'ocean' },
                { id: 'theme1c10', name: '1C · Slate', font: 'Inter', accent: '#4f5b66', bg: '#fafbfc', style: 'noir' }
            ];

            function twoColRender(d, accent, leftBg, font, bullet, cols, shadow, radius) {
                return `<div class="resume" style="width:210mm; padding:12mm; background:white; display:grid; grid-template-columns:${cols}; gap:6mm 8mm; font-family:'${font}', sans-serif; line-height:1.5; color:#1e2b3c; box-shadow:${shadow}; border-radius:${radius};">
                    <div style="grid-column:1/-1; display:flex; align-items:center; gap:16px; margin-bottom:2mm;">
                        ${d.profileImage?`<img src="${d.profileImage}" style="width:56px;height:56px;border-radius:50%;border:3px solid ${accent}; box-shadow:0 4px 12px ${accent}30;">`:''}
                        <h1 style="font-size:30pt; font-weight:700; color:${accent}; margin:0; letter-spacing:-0.02em;">${d.name}</h1>
                    </div>
                    <div style="grid-column:1/-1; display:flex; gap:8mm; border-bottom:2px solid ${accent}30; padding-bottom:3mm; font-size:11pt; color:#2a4c5c;">
                        ${[d.email, d.phone, d.location].join(' · ')}
                    </div>
                    <div style="background:${leftBg}; padding:6mm 5mm; border-radius:20px; box-shadow:inset 0 0 0 1px ${accent}20;">
                        ${d.visibility.skills?`<section style="margin-bottom:5mm;"><h2 style="font-size:15pt; font-weight:700; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:4mm; letter-spacing:0.5px;">SKILLS</h2><div style="display:flex; flex-wrap:wrap; gap:3mm;">${d.skills.map(s=>`<span style="background:white; border:1px solid ${accent}50; padding:2mm 4mm; font-size:10pt; border-radius:40px; color:${accent};">${s}</span>`).join('')}</div></section>`:''}
                        ${d.visibility.education?`<section><h2 style="font-size:15pt; font-weight:700; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:4mm;">EDUCATION</h2>${d.education.map(e=>`<div style="margin-bottom:4mm;"><div style="display:flex; justify-content:space-between;"><span style="font-weight:700; color:#1e3a47;">${e.degree}</span><span style="color:${accent};">${e.year}</span></div><p style="color:#3d5a68;">${e.school}</p></div>`).join('')}</section>`:''}
                        ${d.visibility.certifications && d.certifications.length?`<section style="margin-top:5mm;"><h2 style="font-size:15pt; font-weight:700; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:4mm;">CERTIFICATIONS</h2><ul style="list-style:none; padding-left:2mm;">${d.certifications.map(c=>`<li style="position:relative; padding-left:5mm; margin-bottom:1.5mm; color:#2d5a68;"><span style="position:absolute; left:0; color:${accent}; font-size:14px;">${bullet}</span>${c}</li>`).join('')}</ul></section>`:''}
                    </div>
                    <div style="padding-top:2mm;">
                        ${d.visibility.profile?`<section style="margin-bottom:6mm;"><h2 style="font-size:15pt; font-weight:700; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:4mm;">PROFILE</h2><p style="line-height:1.7; color:#2b4e5e;">${d.summary}</p></section>`:''}
                        ${d.visibility.experience?`<section><h2 style="font-size:15pt; font-weight:700; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:4mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:2mm;"><span style="font-weight:700; font-size:13pt; color:#1e3a47;">${job.role}</span><span style="color:${accent}; font-weight:500;">${job.company}</span><span style="color:#3f6a7a;">${job.date}</span></div><ul style="list-style:none; padding-left:2mm;">${job.bullets.map(b=>`<li style="position:relative; padding-left:5mm; margin-bottom:1.5mm; color:#2b4e5e; line-height:1.6;"><span style="position:absolute; left:0; color:${accent}; font-size:14px;">${bullet}</span>${b}</li>`).join('')}</ul></div>`).join('')}</section>`:''}
                    </div>
                </div>`;
            }

            function renderSection(sectionName, d, font, accent, bg, style) {
                switch(sectionName) {
                    case 'profile':
                        if (!d.visibility.profile) return '';
                        if (style === 'ats') {
                            return `<p style="margin-bottom:5mm;">${d.summary}</p>`;
                        } else if (style === 'minimal') {
                            return `<p style="font-size:11pt; line-height:1.8; color:#405b6a; margin-bottom:5mm;">${d.summary}</p>`;
                        } else if (style === 'creative') {
                            return `<p style="font-size:11.5pt; line-height:1.7; margin-bottom:5mm;">${d.summary}</p>`;
                        } else if (style === 'dark') {
                            return `<p style="font-size:12pt; line-height:1.7; margin-bottom:6mm; color:#d1dfe8;">${d.summary}</p>`;
                        } else if (style === 'mono') {
                            return `<p style="margin-bottom:5mm;"><span style="background:${accent}; color:white; padding:0 2mm;">SUMMARY</span> ${d.summary}</p>`;
                        } else if (style === 'classic') {
                            return `<p style="font-size:11.5pt; font-style:italic; margin-bottom:5mm;">${d.summary}</p>`;
                        } else if (style === 'linen') {
                            return `<p style="font-size:12pt; line-height:1.7; margin-bottom:6mm;">${d.summary}</p>`;
                        } else if (style === 'ocean') {
                            return `<p style="font-size:11.5pt; line-height:1.7; margin-bottom:5mm;">${d.summary}</p>`;
                        } else if (style === 'noir') {
                            return `<p style="font-size:11pt; line-height:1.7; margin-bottom:5mm;">${d.summary}</p>`;
                        } else {
                            return `<section style="margin-bottom:6mm;"><h2 style="font-size:15pt; font-weight:700; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:4mm;">PROFILE</h2><p style="line-height:1.7; color:#2b4e5e;">${d.summary}</p></section>`;
                        }
                    case 'experience':
                        if (!d.visibility.experience) return '';
                        if (style === 'ats') {
                            return `<section><h2 style="font-size:14pt; font-weight:700; border-bottom:1px solid #aaa; margin-bottom:4mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:4mm;"><div style="display:flex; justify-content:space-between; font-weight:700;"><span>${job.role}</span><span>${job.company}</span><span style="font-weight:400;">${job.date}</span></div><ul style="margin-top:1mm;">${job.bullets.map(b=>`<li style="margin-bottom:0.75mm;">${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'minimal') {
                            return `<section><h2 style="font-size:14pt; font-weight:600; border-bottom:2px solid ${accent}60; margin-bottom:4mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between;"><span style="font-weight:700;">${job.role}</span><span style="color:${accent};">${job.company}</span><span>${job.date}</span></div><ul style="padding-left:4mm;">${job.bullets.map(b=>`<li style="margin-bottom:0.75mm;">${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'creative') {
                            return `<section><h2 style="font-size:16pt; font-weight:600; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:5mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between;"><span style="font-weight:700;">${job.role}</span><span style="color:${accent};">${job.company}</span><span>${job.date}</span></div><ul style="margin-top:2mm;">${job.bullets.map(b=>`<li style="margin-bottom:0.75mm;">${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'dark') {
                            return `<section style="margin-bottom:5mm;"><h2 style="font-size:18pt; font-weight:500; color:${accent}; border-bottom:1px solid ${accent}60; padding-bottom:2mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between; font-weight:600;"><span style="color:#e6d8b5;">${job.role}</span><span>${job.company}</span><span>${job.date}</span></div><ul style="list-style:none; padding-left:2mm;">${job.bullets.map(b=>`<li style="position:relative; padding-left:4mm; margin-bottom:1mm;"><span style="position:absolute; left:0; color:${accent};">✦</span>${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'mono') {
                            return `<section><h2 style="font-size:16pt; border-bottom:2px dashed ${accent}; padding-bottom:1mm;">## EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:4mm;"><p><strong>${job.role}</strong> @ ${job.company} [${job.date}]</p><ul style="list-style-type:'→ ';">${job.bullets.map(b=>`<li style="margin-left:4mm;">${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'classic') {
                            return `<section><h2 style="font-size:18pt; font-weight:600; color:${accent}; border-bottom:1px solid #d8c9b5;">Professional Experience</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between;"><span style="font-weight:700;">${job.role}</span><span style="color:${accent};">${job.company}</span><span>${job.date}</span></div><ul>${job.bullets.map(b=>`<li>${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'linen') {
                            return `<section><h2 style="font-size:18pt; font-weight:500; color:#8b6b4f; border-bottom:2px solid ${accent}60;">Work</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between;"><span style="font-weight:700;">${job.role}</span><span>${job.company}</span><span style="color:${accent};">${job.date}</span></div><ul style="margin-top:2mm;">${job.bullets.map(b=>`<li>${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'ocean') {
                            return `<section><h2 style="font-size:18pt; font-weight:500; color:${accent};">Experience</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm; border-bottom:1px solid ${accent}30; padding-bottom:3mm;"><div style="display:flex; justify-content:space-between; font-weight:600;"><span>${job.role}</span><span style="color:${accent};">${job.company}</span><span>${job.date}</span></div><ul style="margin-top:2mm;">${job.bullets.map(b=>`<li>${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else if (style === 'noir') {
                            return `<section><h2 style="font-size:15pt; font-weight:600; color:#2c3e50; border-bottom:1px solid #c0ced6; padding-bottom:1mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:4mm;"><div style="display:flex; justify-content:space-between; margin-bottom:1mm;"><span style="font-weight:600;">${job.role}</span><span style="color:#4a6676;">${job.company}</span><span style="color:#657b89;">${job.date}</span></div><ul style="padding-left:4mm;">${job.bullets.map(b=>`<li style="margin-bottom:0.75mm;">${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        } else {
                            return `<section><h2 style="font-size:16pt; font-weight:600; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:5mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:6mm;"><div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:1mm;"><span style="font-weight:700; font-size:13pt;">${job.role}</span><span style="color:${accent};">${job.company}</span><span style="color:#3f6a7a;">${job.date}</span></div><ul style="padding-left:4mm; margin:2mm 0 0 0;">${job.bullets.map(b=>`<li style="margin-bottom:1.5mm; line-height:1.6;">${b}</li>`).join('')}</ul></div>`).join('')}</section>`;
                        }
                    case 'education':
                        if (!d.visibility.education) return '';
                        if (style === 'ats') {
                            return `<section><h2 style="font-size:14pt; font-weight:700; border-bottom:1px solid #aaa; margin-bottom:4mm;">EDUCATION</h2>${d.education.map(edu=>`<div><strong>${edu.degree}</strong>, ${edu.school} (${edu.year})</div>`).join('')}</section>`;
                        } else if (style === 'minimal') {
                            return `<section><h2 style="font-size:14pt; font-weight:600; border-bottom:2px solid ${accent}60; margin-bottom:4mm;">EDUCATION</h2>${d.education.map(edu=>`<div style="margin-bottom:3mm;"><span style="font-weight:700;">${edu.degree}</span><br><span>${edu.school}, ${edu.year}</span></div>`).join('')}</section>`;
                        } else {
                            return `<section><h2 style="font-size:16pt; font-weight:600; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:5mm;">EDUCATION</h2>${d.education.map(edu=>`<div style="margin-bottom:3mm;"><span style="font-weight:700;">${edu.degree}</span><br><span>${edu.school}, ${edu.year}</span></div>`).join('')}</section>`;
                        }
                    case 'skills':
                        if (!d.visibility.skills) return '';
                        if (style === 'ats') {
                            return `<section style="margin-top:4mm;"><h2 style="font-size:14pt; font-weight:700; border-bottom:1px solid #aaa; margin-bottom:4mm;">SKILLS</h2><p>${d.skills.join(' · ')}</p></section>`;
                        } else if (style === 'minimal') {
                            return `<section style="margin-top:4mm;"><h2 style="font-size:14pt; font-weight:600; border-bottom:2px solid ${accent}60; margin-bottom:4mm;">SKILLS</h2><div style="display:flex; flex-wrap:wrap; gap:2mm 4mm;">${d.skills.map(s=>`<span style="background:${accent}10; color:${accent}; padding:1.5mm 4mm; border-radius:30px; font-size:10.5pt; border:1px solid ${accent}30;">${s}</span>`).join('')}</div></section>`;
                        } else {
                            return `<section style="margin-top:5mm;"><h2 style="font-size:16pt; font-weight:600; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:5mm;">SKILLS</h2><div style="display:flex; flex-wrap:wrap; gap:2mm 4mm;">${d.skills.map(s=>`<span style="background:${accent}10; color:${accent}; padding:1.5mm 4mm; border-radius:30px; font-size:10.5pt; border:1px solid ${accent}30;">${s}</span>`).join('')}</div></section>`;
                        }
                    case 'certifications':
                        if (!d.visibility.certifications || !d.certifications.length) return '';
                        if (style === 'ats') {
                            return `<section style="margin-top:4mm;"><h2 style="font-size:14pt; font-weight:700; border-bottom:1px solid #aaa; margin-bottom:4mm;">CERTIFICATIONS</h2><ul>${d.certifications.map(c=>`<li>${c}</li>`).join('')}</ul></section>`;
                        } else {
                            return `<section style="margin-top:5mm;"><h2 style="font-size:16pt; font-weight:600; color:${accent}; border-bottom:2px solid ${accent}60; padding-bottom:2mm; margin-bottom:5mm;">CERTIFICATIONS</h2><ul style="list-style:none; padding-left:0;">${d.certifications.map(c=>`<li style="margin-bottom:1.5mm; padding-left:2mm;">✓ ${c}</li>`).join('')}</ul></section>`;
                        }
                    default:
                        return '';
                }
            }

            function singleColumnRender(d, font, accent, bg, style) {
                const baseStyle = `width:210mm; padding:15mm 18mm; background:${bg}; font-family:'${font}', sans-serif; line-height:1.6; color:#1e2e3f;`;
                
                let headerHtml = '';
                if (style === 'executive') {
                    headerHtml = `<div style="display:flex; align-items:center; gap:12px; margin-bottom:6mm;">${d.profileImage?`<img src="${d.profileImage}" style="width:80px;height:80px;border-radius:50%;border:3px solid ${accent};">`:''}<div><h1 style="font-size:42pt; font-weight:600; color:${accent}; letter-spacing:-0.02em; line-height:1.1;">${d.name}</h1><p style="font-size:16pt; font-weight:400; color:#4a6676; margin-top:4px;">${d.title}</p></div></div>`;
                } else if (style === 'ats') {
                    headerHtml = `<h1 style="font-size:32pt; font-weight:700; margin-bottom:2mm; color:#222;">${d.name}</h1><p style="font-size:14pt; color:#3a5a6a; margin-bottom:3mm;">${d.title}</p>`;
                } else if (style === 'minimal') {
                    headerHtml = `<div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4mm;"><h1 style="font-size:36pt; font-weight:300; letter-spacing:-1px; color:#2d3c49;">${d.name}</h1>${d.profileImage?`<img src="${d.profileImage}" style="width:50px;height:50px;border-radius:50%;border:2px solid ${accent}60;">`:''}</div><p style="font-size:14pt; font-weight:300; color:#5f7a8a; margin-bottom:5mm;">${d.title}</p>`;
                } else if (style === 'creative') {
                    headerHtml = `<div style="display:flex; align-items:center; gap:16px; margin-bottom:6mm;">${d.profileImage?`<img src="${d.profileImage}" style="width:70px;height:70px;border-radius:50%;border:3px solid ${accent};">`:''}<div><h1 style="font-size:38pt; font-weight:700; color:${accent}; line-height:1;">${d.name}</h1><p style="font-size:16pt; font-weight:500; color:#5d707f;">${d.title}</p></div></div>`;
                } else if (style === 'dark') {
                    const darkBase = `width:210mm; padding:15mm 18mm; background:#0a1a1f; color:#e2eef2; font-family:'${font}', serif; line-height:1.6;`;
                    return `<div class="resume" style="${darkBase}"><div style="display:flex; align-items:center; gap:16px; margin-bottom:6mm;">${d.profileImage?`<img src="${d.profileImage}" style="width:70px;height:70px;border-radius:50%;border:3px solid ${accent};">`:''}<div><h1 style="font-size:40pt; font-weight:600; color:${accent}; letter-spacing:-0.5px;">${d.name}</h1><p style="font-size:18pt; font-weight:300; color:#cbd5e1;">${d.title}</p></div></div><div style="display:flex; gap:8mm; border-bottom:1px solid ${accent}60; padding-bottom:4mm; margin-bottom:6mm; color:#aac3d4;">${[d.email, d.phone, d.location].join(' · ')}</div>${d.visibility.profile?`<p style="font-size:12pt; line-height:1.7; margin-bottom:6mm; color:#d1dfe8;">${d.summary}</p>`:''}${d.visibility.experience?`<section style="margin-bottom:5mm;"><h2 style="font-size:18pt; font-weight:500; color:${accent}; border-bottom:1px solid ${accent}60; padding-bottom:2mm;">EXPERIENCE</h2>${d.experience.map(job=>`<div style="margin-bottom:5mm;"><div style="display:flex; justify-content:space-between; font-weight:600;"><span style="color:#e6d8b5;">${job.role}</span><span>${job.company}</span><span>${job.date}</span></div><ul style="list-style:none; padding-left:2mm;">${job.bullets.map(b=>`<li style="position:relative; padding-left:4mm; margin-bottom:1mm;"><span style="position:absolute; left:0; color:${accent};">✦</span>${b}</li>`).join('')}</ul></div>`).join('')}</section>`:''}${d.visibility.education?`<section><h2 style="font-size:18pt; font-weight:500; color:${accent}; border-bottom:1px solid ${accent}60; padding-bottom:2mm;">EDUCATION</h2>${d.education.map(edu=>`<div><span style="font-weight:600;">${edu.degree}</span>, ${edu.school} (${edu.year})</div>`).join('')}</section>`:''}${d.visibility.skills?`<section style="margin-top:4mm;"><h2 style="font-size:18pt; font-weight:500; color:${accent}; border-bottom:1px solid ${accent}60; padding-bottom:2mm;">SKILLS</h2><div style="display:flex; flex-wrap:wrap; gap:2mm;">${d.skills.map(s=>`<span style="background:#2a4048; padding:2mm 4mm; border-radius:20px; color:#e2eef2;">${s}</span>`).join('')}</div></section>`:''}</div>`;
                } else if (style === 'mono') {
                    headerHtml = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6mm;"><h1 style="font-size:32pt; font-weight:700; color:${accent};">${d.name}</h1>${d.profileImage?`<img src="${d.profileImage}" style="width:60px;height:60px;border-radius:0;border:2px solid ${accent};">`:''}</div><div style="background:#eef6f9; padding:4mm; margin-bottom:5mm;"><p style="font-size:14pt; font-weight:600;">> ${d.title}</p><p>> ${d.email}  |  ${d.phone}  |  ${d.location}</p></div>`;
                } else if (style === 'classic') {
                    headerHtml = `<div style="display:flex; align-items:center; gap:16px; margin-bottom:6mm;">${d.profileImage?`<img src="${d.profileImage}" style="width:70px;height:70px;border-radius:0;border:2px solid ${accent}; padding:2px; background:white;">`:''}<h1 style="font-size:38pt; font-weight:600; color:${accent}; letter-spacing:-0.5px;">${d.name}</h1></div><p style="font-size:16pt; font-weight:400; color:#6d7e8b; margin-bottom:4mm;">${d.title}</p>`;
                } else if (style === 'linen') {
                    headerHtml = `<div style="display:flex; align-items:center; gap:20px; margin-bottom:8mm;">${d.profileImage?`<img src="${d.profileImage}" style="width:80px;height:80px;border-radius:50%;border:3px solid ${accent}60;">`:''}<div><h1 style="font-size:40pt; font-weight:500; color:#5c463b; letter-spacing:-1px;">${d.name}</h1><p style="font-size:16pt; font-weight:400; color:${accent};">${d.title}</p></div></div>`;
                } else if (style === 'ocean') {
                    headerHtml = `<div style="display:flex; align-items:center; gap:16px; margin-bottom:5mm;">${d.profileImage?`<img src="${d.profileImage}" style="width:70px;height:70px;border-radius:50%;border:3px solid ${accent}80; box-shadow:0 4px 12px ${accent}30;">`:''}<h1 style="font-size:38pt; font-weight:600; color:${accent}; text-shadow:0 2px 4px rgba(0,0,0,0.02);">${d.name}</h1></div><p style="font-size:16pt; font-weight:400; color:#3f7c8c; margin-bottom:4mm;">${d.title}</p>`;
                } else if (style === 'noir') {
                    headerHtml = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4mm;"><h1 style="font-size:34pt; font-weight:500; color:#2c3e50;">${d.name}</h1>${d.profileImage?`<img src="${d.profileImage}" style="width:60px;height:60px;border-radius:8px; border:1px solid #b0c4ce;">`:''}</div><p style="font-size:14pt; font-weight:400; color:#5a6e7c; margin-bottom:4mm;">${d.title}</p>`;
                }

                let contactHtml = '';
                if (style === 'ats') {
                    contactHtml = `<div style="display:flex; gap:6mm; font-size:11pt; color:#3a5a6a; margin-bottom:5mm; border-bottom:1px solid #ccc; padding-bottom:3mm;">${[d.email, d.phone, d.location].join(' | ')}</div>`;
                } else if (style === 'minimal') {
                    contactHtml = `<div style="display:flex; gap:6mm; font-size:10pt; color:#6b859c; margin-bottom:5mm;">${[d.email, d.phone, d.location].join(' · ')}</div>`;
                } else if (style === 'creative') {
                    contactHtml = `<div style="display:flex; flex-wrap:wrap; gap:4mm 8mm; background:${accent}08; padding:4mm 6mm; border-radius:40px; margin-bottom:6mm;">${[d.email, d.phone, d.location].map(i=>`<span style="color:${accent};">${i}</span>`).join(' · ')}</div>`;
                } else if (style === 'dark') {
                } else if (style === 'classic') {
                    contactHtml = `<div style="display:flex; gap:6mm; font-size:11pt; border-top:1px solid ${accent}80; border-bottom:1px solid ${accent}80; padding:3mm 0; margin-bottom:5mm;">${[d.email, d.phone, d.location].join(' · ')}</div>`;
                } else if (style === 'linen') {
                    contactHtml = `<div style="display:flex; flex-wrap:wrap; gap:6mm; background:${accent}10; padding:4mm 6mm; border-radius:50px; margin-bottom:6mm;">${[d.email, d.phone, d.location].map(i=>`<span style="color:#6b5a4e;">${i}</span>`).join(' · ')}</div>`;
                } else if (style === 'ocean') {
                    contactHtml = `<div style="display:flex; gap:8mm; background:${accent}10; padding:4mm 6mm; border-radius:40px; margin-bottom:6mm;">${[d.email, d.phone, d.location].join(' · ')}</div>`;
                } else if (style === 'noir') {
                    contactHtml = `<div style="display:flex; gap:6mm; font-size:10.5pt; color:#657b89; margin-bottom:5mm; border-bottom:1px solid #cbd7e0; padding-bottom:3mm;">${[d.email, d.phone, d.location].join(' | ')}</div>`;
                } else {
                    contactHtml = `<div style="display:flex; flex-wrap:wrap; gap:6mm 12mm; margin-bottom:6mm; font-size:11pt; color:#3a5e6c; border-bottom:1px solid ${accent}40; padding-bottom:4mm;">${[d.email, d.phone, d.location].join(' · ')}</div>`;
                }

                if (style === 'dark') {
                    return '';
                }

                let sectionsHtml = '';
                state.sectionOrder.forEach(section => {
                    sectionsHtml += renderSection(section, d, font, accent, bg, style);
                });

                let fullHtml = `<div class="resume" style="${baseStyle}">`;
                fullHtml += headerHtml;
                fullHtml += contactHtml;
                fullHtml += sectionsHtml;
                fullHtml += `</div>`;

                return fullHtml;
            }

            const THEMES = [
                ...twoColThemes.map(t => ({ ...t, render: (d) => twoColRender(d, t.accent, t.leftBg, t.font, t.bullet, t.cols, t.shadow, t.radius) })),
                ...singleThemes.map(t => ({ ...t, render: (d) => singleColumnRender(d, t.font, t.accent, t.bg, t.style) }))
            ];

            function renderPreview() {
                const themeId = state.activeTheme;
                const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
                document.getElementById('resumePreview').innerHTML = theme.render(state);
            }

            function renderForm() {
                const container = document.getElementById('formPanel');
                let html = `<h2 style="margin-bottom:28px;font-size:24px;font-weight:600;color:#0f2a36;">✶ Profile Architect</h2>`;
                html += `<div class="form-section"><div class="section-title"><span><svg class="icon" style="stroke:#1a404f;"><use href="#icon-brand"></use></svg> Profile image</span></div><div onclick="document.getElementById('profileUpload').click()" style="display:flex;align-items:center;gap:16px;background:#f3f9fc;padding:16px;border-radius:40px;cursor:pointer;"><svg class="icon"><use href="#icon-plus"></use></svg><span id="uploadText">${state.profileImage?'Update photo':'Upload headshot'}</span></div><input type="file" id="profileUpload" accept="image/*" style="display:none;"><div id="profilePreview" style="margin-top:16px;text-align:center;">${state.profileImage?`<img src="${state.profileImage}" class="profile-img">`:''}</div></div>`;
                html += `<div class="form-section"><div class="section-title"><svg class="icon"><use href="#icon-drag"></use></svg> Section order</div><div id="sectionSortable" class="sortable-list">`;
                state.sectionOrder.forEach(s => html += `<div class="section-drag" draggable="true" data-section="${s}"><span class="drag-handle"><svg class="icon"><use href="#icon-drag"></use></svg></span> ${s.charAt(0).toUpperCase()+s.slice(1)}</div>`);
                html += `</div></div>`;
                html += `<div class="form-section"><div class="section-title"><svg class="icon"><use href="#icon-ats"></use></svg> Visibility</div>`;
                ['profile','experience','education','skills','certifications'].forEach(s => html += `<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;"><input type="checkbox" id="vis_${s}" ${state.visibility[s]?'checked':''} style="width:20px;height:20px;"><label for="vis_${s}" style="text-transform:capitalize;">${s}</label></div>`);
                html += `</div>`;
                html += `<div class="form-section"><div class="section-title">👤 Personal</div>`;
                ['name','title','email','phone','location'].forEach(f => html += `<div class="form-group"><label>${f}</label><input type="text" id="input_${f}" value="${(state[f]||'').replace(/"/g,'&quot;')}" placeholder="e.g. ${f}"><button class="ai-btn" data-field="${f}" data-type="text"><svg class="icon"><use href="#icon-ai"></use></svg></button></div>`);
                html += `</div>`;
                html += `<div class="form-section"><div class="section-title">📝 Summary</div><div class="form-group"><textarea id="input_summary" rows="4" placeholder="Professional summary...">${state.summary}</textarea><button class="ai-btn" data-field="summary" data-type="textarea"><svg class="icon"><use href="#icon-ai"></use></svg></button></div></div>`;
                html += `<div class="form-section"><div class="section-title"><span>💼 Experience</span><button id="addExpBtn" class="add-btn"><svg class="icon"><use href="#icon-plus"></use></svg> Add job</button></div><div id="expList">`;
                state.experience.forEach((exp, idx) => {
                    html += `<div class="item-card" data-exp-id="${exp.id}"><div class="item-header"><span style="font-weight:700;">${exp.role || 'New role'}</span><div class="item-actions"><button class="item-btn duplicate-exp" data-id="${exp.id}"><svg class="icon-sm"><use href="#icon-duplicate"></use></svg> Duplicate</button><button class="item-btn remove-exp" data-id="${exp.id}"><svg class="icon-sm"><use href="#icon-trash"></use></svg> Remove</button></div></div>`;
                    html += `<div class="form-group"><label>Title · Company</label><input type="text" class="exp_role" data-id="${exp.id}" value="${exp.role} · ${exp.company}"><button class="ai-btn" data-field="exp_role_${exp.id}"><svg class="icon"><use href="#icon-ai"></use></svg></button></div>`;
                    html += `<div class="form-group"><label>Dates</label><input type="text" class="exp_date" data-id="${exp.id}" value="${exp.date}"></div>`;
                    exp.bullets.forEach((b, bidx) => html += `<div class="form-group"><label>Bullet ${bidx+1}</label><textarea rows="2" class="exp_bullet" data-id="${exp.id}" data-bidx="${bidx}">${b}</textarea><button class="ai-btn" data-field="exp_bullet_${exp.id}_${bidx}"><svg class="icon"><use href="#icon-ai"></use></svg></button></div>`);
                    html += `<button class="add-btn add-bullet" data-id="${exp.id}" style="margin-top:8px;"><svg class="icon"><use href="#icon-plus"></use></svg> Add bullet</button></div>`;
                });
                html += `</div></div>`;
                html += `<div class="form-section"><div class="section-title"><span>🎓 Education</span><button id="addEduBtn" class="add-btn"><svg class="icon"><use href="#icon-plus"></use></svg> Add education</button></div><div id="eduList">`;
                state.education.forEach(edu => {
                    html += `<div class="item-card" data-edu-id="${edu.id}"><div class="item-header"><span style="font-weight:700;">${edu.degree || 'Degree'}</span><div class="item-actions"><button class="item-btn duplicate-edu" data-id="${edu.id}"><svg class="icon-sm"><use href="#icon-duplicate"></use></svg> Duplicate</button><button class="item-btn remove-edu" data-id="${edu.id}"><svg class="icon-sm"><use href="#icon-trash"></use></svg> Remove</button></div></div>`;
                    html += `<div class="form-group"><label>Degree</label><input type="text" class="edu_degree" data-id="${edu.id}" value="${edu.degree}"><button class="ai-btn" data-field="edu_degree_${edu.id}"><svg class="icon"><use href="#icon-ai"></use></svg></button></div>`;
                    html += `<div class="form-group"><label>School</label><input type="text" class="edu_school" data-id="${edu.id}" value="${edu.school}"></div>`;
                    html += `<div class="form-group"><label>Year</label><input type="text" class="edu_year" data-id="${edu.id}" value="${edu.year}"></div>`;
                    html += `</div>`;
                });
                html += `</div></div>`;
                html += `<div class="form-section"><div class="section-title"><span>🔧 Skills</span><button id="skillAIBtn" class="add-btn" style="background:#d9eaf0;"><svg class="icon"><use href="#icon-predict"></use></svg> Predict skills</button></div><div class="form-group"><label>Skills (comma separated)</label><input type="text" id="input_skills" value="${state.skills.join(', ')}"><button class="ai-btn" data-field="skills"><svg class="icon"><use href="#icon-ai"></use></svg></button></div><div style="display:flex; flex-wrap:wrap; margin-top:12px;">${state.skills.map(s => `<span class="skill-chip">${s}</span>`).join('')}</div></div>`;
                html += `<div class="form-section"><div class="section-title"><span>📜 Certifications</span><button id="addCertBtn" class="add-btn"><svg class="icon"><use href="#icon-plus"></use></svg> Add certification</button></div><div id="certList">`;
                state.certifications.forEach((cert, idx) => {
                    html += `<div class="cert-item"><input type="text" class="cert-input" data-cert-index="${idx}" value="${cert}" placeholder="Certification name"><button class="item-btn remove-cert" data-index="${idx}" style="margin-left:auto;"><svg class="icon-sm"><use href="#icon-trash"></use></svg> Remove</button></div>`;
                });
                html += `</div></div>`;
                container.innerHTML = html;
                attachFormEvents();
            }

            function attachFormEvents() {
                const pu = document.getElementById('profileUpload');
                if(pu) {
                    pu.removeEventListener('change', pu._listener);
                    pu._listener = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(ev) {
                                initCropper(ev.target.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    pu.addEventListener('change', pu._listener);
                }

                ['profile','experience','education','skills','certifications'].forEach(s => {
                    const el = document.getElementById(`vis_${s}`);
                    if(el) el.addEventListener('change', e => { state.visibility[s] = e.target.checked; renderPreview(); persist(); });
                });

                document.querySelectorAll('input[id^="input_"], #input_summary, #input_skills, #input_certs').forEach(el => {
                    el.addEventListener('input', function(e){
                        const id = this.id.replace('input_','');
                        if(id === 'skills') state.skills = this.value.split(',').map(s=>s.trim());
                        else if(id === 'certs') state.certifications = this.value.split(',').map(s=>s.trim());
                        else if(id === 'summary') state.summary = this.value;
                        else state[id] = this.value;
                        renderPreview(); persist();
                    });
                });

                document.querySelectorAll('.ai-btn').forEach(btn => {
                    btn.addEventListener('click', function(e){
                        e.preventDefault();
                        const field = this.dataset.field;
                        const input = this.parentElement.querySelector('input,textarea');
                        if(input) openAIAssist(field, input, input.value);
                    });
                });

                document.getElementById('addExpBtn')?.addEventListener('click', function(){
                    const newId = 'exp' + Date.now() + Math.random();
                    state.experience.push({ id: newId, role: 'New Position', company: 'Company', date: 'Present', bullets: ['Add accomplishment'] });
                    renderForm(); renderPreview(); persist();
                });

                document.getElementById('addEduBtn')?.addEventListener('click', function(){
                    const newId = 'edu' + Date.now() + Math.random();
                    state.education.push({ id: newId, degree: 'New Degree', school: 'University', year: '2025' });
                    renderForm(); renderPreview(); persist();
                });

                document.getElementById('addCertBtn')?.addEventListener('click', addCertificate);

                document.querySelectorAll('.remove-cert').forEach(btn => {
                    btn.addEventListener('click', function(){
                        const idx = parseInt(this.dataset.index);
                        removeCertificate(idx);
                    });
                });

                document.querySelectorAll('.cert-input').forEach(inp => {
                    inp.addEventListener('input', function(){
                        const idx = parseInt(this.dataset.certIndex);
                        state.certifications[idx] = this.value;
                        renderPreview(); persist();
                    });
                });

                document.querySelectorAll('.remove-exp').forEach(btn => btn.addEventListener('click', function(){
                    state.experience = state.experience.filter(e => e.id !== this.dataset.id);
                    renderForm(); renderPreview(); persist();
                }));
                document.querySelectorAll('.duplicate-exp').forEach(btn => btn.addEventListener('click', function(){
                    const exp = state.experience.find(e => e.id === this.dataset.id);
                    if(exp) { const copy = JSON.parse(JSON.stringify(exp)); copy.id = 'exp' + Date.now() + Math.random(); state.experience.push(copy); renderForm(); renderPreview(); persist(); }
                }));
                document.querySelectorAll('.remove-edu').forEach(btn => btn.addEventListener('click', function(){
                    state.education = state.education.filter(e => e.id !== this.dataset.id);
                    renderForm(); renderPreview(); persist();
                }));
                document.querySelectorAll('.duplicate-edu').forEach(btn => btn.addEventListener('click', function(){
                    const edu = state.education.find(e => e.id === this.dataset.id);
                    if(edu) { const copy = JSON.parse(JSON.stringify(edu)); copy.id = 'edu' + Date.now() + Math.random(); state.education.push(copy); renderForm(); renderPreview(); persist(); }
                }));
                document.querySelectorAll('.add-bullet').forEach(btn => btn.addEventListener('click', function(){
                    const exp = state.experience.find(e => e.id === this.dataset.id);
                    if(exp) { exp.bullets.push('New responsibility'); renderForm(); renderPreview(); persist(); }
                }));

                document.querySelectorAll('.exp_role').forEach(inp => inp.addEventListener('input', function(){
                    let id = this.dataset.id; let parts = this.value.split('·'); let exp = state.experience.find(e=>e.id===id);
                    if(exp) { exp.role = parts[0].trim(); exp.company = parts[1]?.trim()||''; renderPreview(); persist(); }
                }));
                document.querySelectorAll('.exp_date').forEach(inp => inp.addEventListener('input', function(){
                    let id = this.dataset.id; let exp = state.experience.find(e=>e.id===id); if(exp) { exp.date = this.value; renderPreview(); persist(); }
                }));
                document.querySelectorAll('.exp_bullet').forEach(inp => inp.addEventListener('input', function(){
                    let id = this.dataset.id; let bidx = this.dataset.bidx; let exp = state.experience.find(e=>e.id===id);
                    if(exp && exp.bullets[bidx]) { exp.bullets[bidx] = this.value; renderPreview(); persist(); }
                }));
                document.querySelectorAll('.edu_degree').forEach(inp => inp.addEventListener('input', function(){
                    let id = this.dataset.id; let edu = state.education.find(e=>e.id===id); if(edu) { edu.degree = this.value; renderPreview(); persist(); }
                }));
                document.querySelectorAll('.edu_school').forEach(inp => inp.addEventListener('input', function(){
                    let id = this.dataset.id; let edu = state.education.find(e=>e.id===id); if(edu) { edu.school = this.value; renderPreview(); persist(); }
                }));
                document.querySelectorAll('.edu_year').forEach(inp => inp.addEventListener('input', function(){
                    let id = this.dataset.id; let edu = state.education.find(e=>e.id===id); if(edu) { edu.year = this.value; renderPreview(); persist(); }
                }));

                const sortable = document.getElementById('sectionSortable');
                if(sortable) {
                    let dragged;
                    sortable.addEventListener('dragstart', e => { dragged = e.target; e.target.classList.add('dragging'); });
                    sortable.addEventListener('dragend', e => e.target.classList.remove('dragging'));
                    sortable.addEventListener('dragover', e => { e.preventDefault(); const after = getDragAfterElement(sortable, e.clientY); if(after) sortable.insertBefore(dragged, after); else sortable.appendChild(dragged);
                        const newOrder = Array.from(sortable.children).map(el => el.dataset.section);
                        state.sectionOrder = newOrder; renderPreview(); persist();
                    });
                }

                document.getElementById('skillAIBtn')?.addEventListener('click', function(){
                    openSkillAIAssist();
                });
            }

            function addCertificate() {
                state.certifications.push('New Certification');
                renderForm(); renderPreview(); persist();
            }
            function removeCertificate(index) {
                state.certifications.splice(index, 1);
                renderForm(); renderPreview(); persist();
            }

            let selectedSkillSuggestions = new Set();
            function openSkillAIAssist() {
                const modal = document.getElementById('aiSkillModal');
                const listDiv = document.getElementById('skillSuggestionsList');
                const titleWords = (state.title || '').toLowerCase().split(' ');
                const summaryWords = (state.summary || '').toLowerCase().split(' ');
                const existing = new Set(state.skills.map(s => s.toLowerCase()));
                
                const skillPool = [
                    'User Research', 'Wireframing', 'Prototyping', 'Figma', 'Adobe XD', 'Sketch',
                    'InVision', 'HTML', 'CSS', 'JavaScript', 'React', 'Vue', 'Angular', 'Node.js',
                    'Python', 'SQL', 'AWS', 'Azure', 'DevOps', 'Docker', 'Kubernetes',
                    'Agile', 'Scrum', 'Jira', 'Confluence', 'Leadership', 'Mentoring',
                    'Product Management', 'A/B Testing', 'Analytics', 'Google Analytics',
                    'UI Design', 'Interaction Design', 'Visual Design', 'Typography',
                    'Color Theory', 'Branding', 'Illustrator', 'Photoshop', 'After Effects',
                    'Responsive Design', 'Accessibility', 'WCAG', 'User Testing', 'Usability',
                    'Information Architecture', 'Sitemaps', 'User Flows', 'Journey Mapping',
                    'Design Systems', 'Storyboarding', 'Rapid Prototyping', 'Framer', 'Principle'
                ];
                const scored = skillPool.map(skill => {
                    let score = 0;
                    const skillLower = skill.toLowerCase();
                    if (existing.has(skillLower)) score = -1;
                    if (titleWords.some(w => skillLower.includes(w) || w.includes(skillLower))) score += 3;
                    if (summaryWords.some(w => skillLower.includes(w) || w.includes(skillLower))) score += 2;
                    if (state.title.includes('UX') && skillLower.includes('user')) score += 2;
                    if (state.title.includes('Product') && (skillLower.includes('product') || skillLower.includes('management'))) score += 2;
                    return { skill, score };
                }).filter(s => s.score >= 0).sort((a,b) => b.score - a.score).slice(0, 15);
                
                let html = '';
                scored.forEach((item, idx) => {
                    const checked = selectedSkillSuggestions.has(item.skill) ? 'checked' : '';
                    html += `<div style="padding:12px; background:#f2fafd; border-radius:14px; margin-bottom:10px; display:flex; align-items:center;">
                        <input type="checkbox" id="skill_${idx}" value="${item.skill}" ${checked} style="width:20px;height:20px;margin-right:16px;">
                        <label for="skill_${idx}" style="font-size:15px; flex:1; cursor:pointer;">${item.skill}</label>
                    </div>`;
                });
                listDiv.innerHTML = html || '<p style="color:#6f8f9c;">No new skill suggestions.</p>';
                modal.style.display = 'flex';
                selectedSkillSuggestions.clear();
            }

            let activeAIField = null, activeAIElement = null, originalValue = '';
            window.openAIAssist = (field, element, value) => {
                activeAIField = field; activeAIElement = element; originalValue = value;
                document.getElementById('aiOriginal').innerHTML = `<strong>Original:</strong> ${value}`;
                let suggestions = [];
                if(field.includes('summary') || field.includes('bullet')) {
                    suggestions = [
                        value + ' (clarity: active voice)',
                        'Leveraged ' + value.split(' ').slice(0,5).join(' ') + ' to drive measurable outcomes.',
                        'Spearheaded initiatives including ' + value.split(' ').slice(0,3).join(' ') + '... (ATS optimized)'
                    ];
                } else if(field.includes('role') || field.includes('degree')) {
                    suggestions = [
                        value + ' (senior-level focus)',
                        value.split('·')[0] + ' · ' + (value.split('·')[1] || 'Company') + ' (leadership)',
                        value.toUpperCase()
                    ];
                } else {
                    suggestions = [
                        value + ' (refined)',
                        value.split(' ').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' '),
                        value.replace(/e/g, '3')
                    ];
                }
                let sugHtml = '<p style="margin-bottom:12px;font-weight:600;">Suggestions:</p>';
                suggestions.forEach((s, i) => {
                    sugHtml += `<div class="ai-suggestion" style="cursor:pointer;" data-suggestion="${s.replace(/"/g,'&quot;')}">${s}</div>`;
                });
                document.getElementById('aiSuggestions').innerHTML = sugHtml;
                document.getElementById('aiModal').style.display = 'flex';
                document.querySelectorAll('.ai-suggestion').forEach(el => {
                    el.addEventListener('click', function(){
                        document.querySelectorAll('.ai-suggestion').forEach(e => e.style.background = '#f2fcfe');
                        this.style.background = '#d5f0f5';
                        document.getElementById('aiApply').onclick = () => {
                            activeAIElement.value = this.dataset.suggestion;
                            updateFieldFromAI(field, this.dataset.suggestion);
                            document.getElementById('aiModal').style.display = 'none';
                        };
                    });
                });
            };
            function updateFieldFromAI(field, val) {
                if(field === 'summary') state.summary = val;
                else if(field === 'name') state.name = val;
                else if(field === 'title') state.title = val;
                else if(field === 'email') state.email = val;
                else if(field === 'phone') state.phone = val;
                else if(field === 'location') state.location = val;
                else if(field === 'skills') state.skills = val.split(',').map(s=>s.trim());
                else if(field === 'certs') state.certifications = val.split(',').map(s=>s.trim());
                else if(field.startsWith('exp_role_')) {
                    let id = field.replace('exp_role_','');
                    let exp = state.experience.find(e=>e.id===id);
                    if(exp) { let parts = val.split('·'); exp.role = parts[0].trim(); exp.company = parts[1]?.trim()||''; }
                } else if(field.startsWith('exp_bullet_')) {
                    let parts = field.split('_');
                    let id = parts[2]; let bidx = parseInt(parts[3]);
                    let exp = state.experience.find(e=>e.id===id);
                    if(exp && exp.bullets[bidx]) exp.bullets[bidx] = val;
                } else if(field.startsWith('edu_degree_')) {
                    let id = field.replace('edu_degree_','');
                    let edu = state.education.find(e=>e.id===id);
                    if(edu) edu.degree = val;
                }
                renderPreview(); persist();
            }

            function getDragAfterElement(container, y) {
                const draggable = [...container.querySelectorAll('.section-drag:not(.dragging)')];
                return draggable.reduce((closest, child) => {
                    const box = child.getBoundingClientRect(); const offset = y - box.top - box.height/2;
                    return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            const ATSEngine = {
                synonyms: { js:'JavaScript', javascript:'JavaScript', reactjs:'React', react:'React', nodejs:'Node.js', node:'Node.js', figma:'Figma', 'adobe xd':'Adobe XD', html:'HTML', css:'CSS' },
                stopwords: new Set(['a','an','the','and','or','but','if','because','as','what','which','this','that','these','those','then','just','so','than','such','both','through','about','for','is','of','while','during','to','from','in','on','at','by','with','without','has','have','be','been','being','was','were','will','would','could','should']),
                extract(text) { if(!text) return []; return text.toLowerCase().split(/[^a-z0-9+.#-]+/).map(t=>t.trim()).filter(t=>t.length>=3 && !this.stopwords.has(t)).map(t=>this.synonyms[t]||t); },
                score(resume, jd) {
                    const jdKw = [...new Set(this.extract(jd))];
                    const resumeText = [resume.summary, ...resume.experience.flatMap(e=>[e.role,e.company,...e.bullets]), ...resume.education.flatMap(e=>[e.degree,e.school]), ...resume.skills, ...resume.certifications].join(' ');
                    const resumeKw = [...new Set(this.extract(resumeText))];
                    const missing = jdKw.filter(k => !resumeKw.includes(k));
                    const match = jdKw.length ? ((jdKw.length - missing.length)/jdKw.length)*100 : 100;
                    let score = Math.min(100, Math.round(match));
                    let suggestions = [];
                    if(missing.length) suggestions.push(`Add missing keywords: ${missing.slice(0,7).join(', ')}`);
                    if(!resume.experience.some(e=>e.bullets.some(b=>/\d+%|\d+ users|\$\d+/.test(b)))) suggestions.push('Quantify achievements with metrics');
                    if(!resume.skills.length) suggestions.push('List relevant skills');
                    return { score, missing, suggestions };
                }
            };

            function printResume() { window.print(); }
            function downloadPdf() { applyPagination(); setTimeout(() => { window.print(); }, 10); }

            function setupCropModal() {
                const modal = document.getElementById('cropModal');
                document.getElementById('cropCancelBtn').addEventListener('click', () => modal.style.display = 'none');
                document.getElementById('cropSaveBtn').addEventListener('click', cropAndSave);
                setupCropEvents();
            }

            function init() {
                const sel = document.getElementById('themeSelector');
                THEMES.forEach(t => { let o = document.createElement('option'); o.value = t.id; o.textContent = t.name; if(t.id === state.activeTheme) o.selected = true; sel.appendChild(o); });
                sel.addEventListener('change', e => { state.activeTheme = e.target.value; renderPreview(); persist(); });
                renderForm();
                renderPreview();
                document.getElementById('saveBtn').addEventListener('click', ()=>{ persist(); alert('Progress saved'); });
                document.getElementById('resetBtn').addEventListener('click', ()=>{ state = JSON.parse(JSON.stringify(DEFAULT_STATE)); renderForm(); renderPreview(); persist(); });
                document.getElementById('printBtn').addEventListener('click', printResume);
                document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdf);
                document.getElementById('analyzeBtn').addEventListener('click', ()=>{
                    const jd = document.getElementById('jobDescription').value;
                    const res = ATSEngine.score(state, jd);
                    document.getElementById('atsContainer').style.display = 'block';
                    document.getElementById('atsScore').innerHTML = `<div style="display:flex;align-items:center;gap:24px;"><span style="font-size:42px;font-weight:700;color:#1a404f;">${res.score}</span><span>/100</span></div><ul style="margin-top:16px;padding-left:20px;">${res.suggestions.map(s=>`<li>${s}</li>`).join('')}</ul>`;
                });
                document.getElementById('aiCancel').addEventListener('click', ()=> document.getElementById('aiModal').style.display = 'none');
                document.getElementById('aiSkillCancel').addEventListener('click', ()=> {
                    document.getElementById('aiSkillModal').style.display = 'none';
                    selectedSkillSuggestions.clear();
                });
                document.getElementById('aiSkillApply').addEventListener('click', ()=>{
                    const checkboxes = document.querySelectorAll('#skillSuggestionsList input[type="checkbox"]:checked');
                    const newSkills = Array.from(checkboxes).map(cb => cb.value).filter(s => !state.skills.includes(s));
                    if(newSkills.length) {
                        state.skills = [...state.skills, ...newSkills];
                        const skillInput = document.getElementById('input_skills');
                        if(skillInput) skillInput.value = state.skills.join(', ');
                        renderPreview(); persist();
                    }
                    document.getElementById('aiSkillModal').style.display = 'none';
                    selectedSkillSuggestions.clear();
                });
                setupCropModal();
                persist();
            }
            init();
        })();
    </script>
</body>
</html>
